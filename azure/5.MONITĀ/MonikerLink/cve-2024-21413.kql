let awsregions_str = 'us-central-1|us-east-1|us-east-2|us-west-1|us-west-2|af-south-1|ap-east-1|ap-south-2|ap-southeast-3|ap-southeast-5|ap-southeast-4|ap-south-1|ap-northeast-3|ap-northeast-2|ap-southeast-1|ap-southeast-2|ap-northeast-1|ca-central-1|ca-west-1|cn-north-1|cn-northwest-1|eu-central-1|eu-west-1|eu-west-2|eu-south-1|eu-west-3|eu-south-2|eu-north-1|eu-central-2|il-central-1|me-south-1|me-central-1|sa-east-1';
let extensions_str = 'exe|dll|bat|ps1|vbs|js|cmd|msi|scr|pdf|com|cpl|jar|sh|jpg|jpeg|png|gif|txt';
let s3Regex = strcat('^http(s)?://(s3.amazonaws.com/([a-zA-Z0-9\\-]+)(/([a-zA-Z0-9\\-]+(\\.(', extensions_str, '))?)?)?|([a-zA-Z0-9\\-]+)\\.s3\\.(', awsregions_str, ')\\.amazonaws\\.com(/([a-zA-Z0-9\\-]+(\\.(', extensions_str, '))?)?)?)$');
let timeRange = 30d;
let ntlmPorts = dynamic([80, 139, 443, 445]); // Ports
// Detect NTLM-related network traffic (over SMB or HTTP)
let ntlmEvents = DeviceNetworkEvents
| where TimeGenerated between (ago(timeRange) .. now())
| where RemotePort in (ntlmPorts) or (RemoteUrl has "NTLM" or RemoteUrl has "NTLMSSP")
| project TimeGenerated, DeviceId, DeviceName, RemoteIP, RemotePort, RemoteUrl, InitiatingProcessFileName;
// Detect potential S3 access with critical extensions
let netEvents = DeviceNetworkEvents
| where TimeGenerated between (ago(timeRange) .. now())
| where isnotempty(RemoteUrl)
| where RemoteUrl matches regex s3Regex
| project TimeGenerated, DeviceId, DeviceName, RemoteIP, RemotePort, RemoteUrl;
// Combine NTLM detection with S3 and file events
fileEvents
| join kind=inner (netEvents) on DeviceId, TimeGenerated
| union (fileEvents | join kind=inner (ntlmEvents) on DeviceId, TimeGenerated) // Union with NTLM detection
| summarize InitialAccessTime=min(TimeGenerated), LastAccessTime=max(TimeGenerated) by DeviceId, FileName, RemoteUrl, RemotePort, InitiatingProcessFileName
| extend AccessDurationISO = strcat("P", datetime_diff('day', LastAccessTime, InitialAccessTime), "DT", 
                                    datetime_diff('hour', LastAccessTime, InitialAccessTime) % 24, "H", 
                                    datetime_diff('minute', LastAccessTime, InitialAccessTime) % 60, "M", 
                                    datetime_diff('second', LastAccessTime, InitialAccessTime) % 60, "S")
| project DeviceId, FileName, InitialAccessTime, LastAccessTime, AccessDurationISO, RemoteUrl, RemotePort, InitiatingProcessFileName
| order by InitialAccessTime asc

// (C) NightCityShogun 2024

let awsregions_str = 'us-central-1|us-east-1|us-east-2|us-west-1|us-west-2|af-south-1|ap-east-1|ap-south-2|ap-southeast-3|ap-southeast-5|ap-southeast-4|ap-south-1|ap-northeast-3|ap-northeast-2|ap-southeast-1|ap-southeast-2|ap-northeast-1|ca-central-1|ca-west-1|cn-north-1|cn-northwest-1|eu-central-1|eu-west-1|eu-west-2|eu-south-1|eu-west-3|eu-south-2|eu-north-1|eu-central-2|il-central-1|me-south-1|me-central-1|sa-east-1';
let extensions_str = 'exe|dll|bat|ps1|vbs|js|cmd|msi|scr|pdf|com|cpl|jar|sh|jpg|jpeg|png|gif|txt';
let s3Regex = strcat('^http(s)?://(s3.amazonaws.com/([a-zA-Z0-9\\-]+)(/([a-zA-Z0-9\\-]+(\\.(', extensions_str, '))?)?)?|([a-zA-Z0-9\\-]+)\\.s3\\.(', awsregions_str, ')\\.amazonaws\\.com(/([a-zA-Z0-9\\-]+(\\.(', extensions_str, '))?)?)?)$');
let timeRange = 30d;
let netEvents = DeviceNetworkEvents
| where TimeGenerated between (ago(timeRange) .. now())
| where isnotempty(RemoteUrl)
| where RemoteUrl matches regex s3Regex
| project TimeGenerated, DeviceId, DeviceName, RemoteIP, RemotePort, RemoteUrl;
netEvents


let awsregions_str = 'us-central-1|us-east-1|us-east-2|us-west-1|us-west-2|af-south-1|ap-east-1|ap-south-2|ap-southeast-3|ap-southeast-5|ap-southeast-4|ap-south-1|ap-northeast-3|ap-northeast-2|ap-southeast-1|ap-southeast-2|ap-northeast-1|ca-central-1|ca-west-1|cn-north-1|cn-northwest-1|eu-central-1|eu-west-1|eu-west-2|eu-south-1|eu-west-3|eu-south-2|eu-north-1|eu-central-2|il-central-1|me-south-1|me-central-1|sa-east-1';
let extensions_str = 'exe|dll|bat|ps1|vbs|js|cmd|msi|scr|pdf|com|cpl|jar|sh|jpg|jpeg|png|gif|txt';
let s3Regex = strcat('https?://(s3\\.amazonaws\\.com/[a-zA-Z0-9\\-_]+(/[a-zA-Z0-9\\-_\\.]+)?(\\.(?:', extensions_str, '))?|[a-zA-Z0-9\\-_]+\\.s3\\.(', awsregions_str, ')\\.amazonaws\\.com(/[a-zA-Z0-9\\-_\\.]+)?(\\.(?:', extensions_str, '))?)');
// Define time range for search
let timeRange = 30d;
// Search for network events within the specified time range and fields containing an S3 URL with optional extensions
let netEvents = DeviceNetworkEvents
| where Timestamp between (ago(timeRange) .. now())
| where isnotempty(RemoteUrl) or isnotempty(InitiatingProcessCommandLine)
| extend CombinedField = coalesce(RemoteUrl, InitiatingProcessCommandLine) // Combine fields if one is empty
| where tolower(CombinedField) matches regex s3Regex  // Match combined field to the regex for S3 URLs with optional extensions
| project Timestamp, DeviceId, DeviceName, RemoteIP, RemotePort, RemoteUrl, InitiatingProcessCommandLine, CombinedField;
netEvents

// (C) NightCityShogun 2024
